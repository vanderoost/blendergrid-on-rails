#!/usr/bin/env ruby

class AutoTest
  WATCHED_PATHS = %w[app test config lib].freeze
  WATCHED_EXTENSIONS = %w[rb erb yml].freeze
  POLL_INTERVAL_SECONDS = 0.5

  def initialize
    @file_times = {}
  end

  def start
    trap('INT') do
      exit
    end

    loop do
      run_tests if a_file_changed?
      sleep POLL_INTERVAL_SECONDS
    end
  end

  private
    def a_file_changed?
      changed = false
      pattern = "**/*.{#{WATCHED_EXTENSIONS.join(',')}}"

      WATCHED_PATHS.each do |path|
        next unless Dir.exist?(path)

        Dir.glob(File.join(path, pattern)).each do |file|
          mtime = File.mtime(file)
          next if @file_times.dig(file) == mtime

          @file_times[file] = mtime
          changed = true
        end
      end

      changed
    end

    def run_tests
      system("clear")
      system("bin/rails test test:system --fail-fast")
    end
end

AutoTest.new.start
