#!/usr/bin/env ruby

require_relative "../config/environment"
require "tempfile"

# Pick the author
users = User.order(:name)
if users.count == 1
  user = users.first
else
  user_list = users.map do |u|
    "#{u.id}|#{u.name}"
  end
  puts "Select author:"
  selected = `echo "#{user_list.join("\n")}" \
    | column -t -s'|' | fzf`.strip
  exit if selected.empty?
  user = User.find(selected.split(/\s+/).first.to_i)
end

# Create temp file with empty frontmatter template
temp_file = Tempfile.new(["article", ".md"])
temp_file.write(<<~CONTENT)
  ---
  title: "New Article"
  slug: "new-article"
  published_at:
  excerpt: ""
  ---

  Write your article here...
CONTENT
temp_file.close

# Edit in neovim
system("nvim #{temp_file.path}")

# Parse the edited content
begin
  content = File.read(temp_file.path)
  if content =~ /^---\n(.*?)\n---\n(.*)/m
    frontmatter = YAML.safe_load(
      $1, permitted_classes: [Time]
    )
    body = $2.strip

    article = Article.create!(
      user: user,
      title: frontmatter["title"],
      slug: frontmatter["slug"],
      body: body,
      excerpt: frontmatter["excerpt"],
      published_at: frontmatter["published_at"]
    )

    status = article.published_at? ? "published" : "draft"
    puts "Created (#{status}): #{article.title}"
    url = "https://blendergrid.com/articles/"
    puts "View at: #{url}#{article.slug}"
    temp_file.unlink
  else
    ObjectSpace.undefine_finalizer(temp_file)
    puts "Error parsing frontmatter"
    puts "Your file is saved at: #{temp_file.path}"
  end
rescue => e
  ObjectSpace.undefine_finalizer(temp_file)
  puts "Error: #{e.message}"
  puts "Your file is saved at: #{temp_file.path}"
end
