<% Project::STAGES.each do |stage| %>
  <% projects = @projects_by_stage.fetch(stage, [])
  next if projects.empty? %>

    <% @projects_by_stage[stage]&.map(&:project_source)&.uniq&.each do |ps| %>
      <%= turbo_stream_from [ps, stage, :projects] %>
    <% end %>
    <!-- TODO: Url needs to be dynamic based on stage -->
    <%= form_with url: price_calculations_path do |form| %>

      <div class="max-w-7xl mx-auto my-8 sm:px-6 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-md">
          <h2 class="mt-6 text-center text-2xl/9 font-bold tracking-tight text-gray-900">
            <%= stage %>
            projects
          </h2>
        </div>

        <ul
          id="stage_<?= project.stage %>"
          role="list"
          class="
            divide-y divide-gray-100 overflow-hidden bg-white ring-1 ring-gray-900/5
            sm:rounded-xl shadow-md mt-6
          "
        >
          <%= render projects %>
        </ul>
      </div>

      <div class="max-w-7xl mx-auto my-8 sm:px-6 lg:px-8">
        <%= form.submit "Submit for #{stage.capitalize}",
                    class:
                      "flex justify-center rounded-md bg-green-600 ml-auto px-4 py-2 font-semibold text-white shadow-md hover:bg-green-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600 cursor-pointer" %>
      </div>

    <% end %>

  <% end %>
