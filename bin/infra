#!/usr/bin/env ruby

# Set up the cloud infrastructure with Terraform

ENV["RAILS_ENV"] = "production"

require "fileutils"
require_relative "../config/application"

Rails.application.initialize!

def system!(*args)
  system(*args, exception: true)
end

db_password = Rails.application.credentials.dig(:database, :password)
raise "Missing database password in credentials" unless db_password
terraform_vars = [ "-var", "db_password=#{db_password}" ]

FileUtils.chdir Rails.root / "terraform" do
  system! "terraform", "init"
  system! "terraform", "apply", "-auto-approve", *terraform_vars
end
