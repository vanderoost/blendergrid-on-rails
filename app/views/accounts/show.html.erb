<% countries = [
  [ "Afghanistan", "AF" ],
  [ "Åland Islands", "AX" ],
  [ "Albania", "AL" ],
  [ "Algeria", "DZ" ],
  [ "American Samoa", "AS" ],
  [ "Andorra", "AD" ],
  [ "Angola", "AO" ],
  [ "Anguilla", "AI" ],
  [ "Antarctica", "AQ" ],
  [ "Antigua and Barbuda", "AG" ],
  [ "Argentina", "AR" ],
  [ "Armenia", "AM" ],
  [ "Aruba", "AW" ],
  [ "Australia", "AU" ],
  [ "Austria", "AT" ],
  [ "Azerbaijan", "AZ" ],
  [ "Bahamas", "BS" ],
  [ "Bahrain", "BH" ],
  [ "Bangladesh", "BD" ],
  [ "Barbados", "BB" ],
  [ "Belarus", "BY" ],
  [ "Belgium", "BE" ],
  [ "Belize", "BZ" ],
  [ "Benin", "BJ" ],
  [ "Bermuda", "BM" ],
  [ "Bhutan", "BT" ],
  [ "Bolivia", "BO" ],
  [ "Bonaire", "BQ" ],
  [ "Bosnia and Herzegovina", "BA" ],
  [ "Botswana", "BW" ],
  [ "Bouvet Island", "BV" ],
  [ "Brazil", "BR" ],
  [ "British Indian Ocean Territory", "IO" ],
  [ "Brunei Darussalam", "BN" ],
  [ "Bulgaria", "BG" ],
  [ "Burkina Faso", "BF" ],
  [ "Burundi", "BI" ],
  [ "Cabo Verde", "CV" ],
  [ "Cambodia", "KH" ],
  [ "Cameroon", "CM" ],
  [ "Canada", "CA" ],
  [ "Cayman Islands", "KY" ],
  [ "Central African Republic", "CF" ],
  [ "Chad", "TD" ],
  [ "Chile", "CL" ],
  [ "China", "CN" ],
  [ "Christmas Island", "CX" ],
  [ "Cocos (Keeling) Islands", "CC" ],
  [ "Colombia", "CO" ],
  [ "Comoros", "KM" ],
  [ "Congo", "CG" ],
  [ "Congo, Democratic Republic of the", "CD" ],
  [ "Cook Islands", "CK" ],
  [ "Costa Rica", "CR" ],
  [ "Côte d'Ivoire", "CI" ],
  [ "Croatia", "HR" ],
  [ "Cuba", "CU" ],
  [ "Curaçao", "CW" ],
  [ "Cyprus", "CY" ],
  [ "Czechia", "CZ" ],
  [ "Denmark", "DK" ],
  [ "Djibouti", "DJ" ],
  [ "Dominica", "DM" ],
  [ "Dominican Republic", "DO" ],
  [ "Ecuador", "EC" ],
  [ "Egypt", "EG" ],
  [ "El Salvador", "SV" ],
  [ "Equatorial Guinea", "GQ" ],
  [ "Eritrea", "ER" ],
  [ "Estonia", "EE" ],
  [ "Eswatini", "SZ" ],
  [ "Ethiopia", "ET" ],
  [ "Falkland Islands", "FK" ],
  [ "Faroe Islands", "FO" ],
  [ "Fiji", "FJ" ],
  [ "Finland", "FI" ],
  [ "France", "FR" ],
  [ "French Guiana", "GF" ],
  [ "French Polynesia", "PF" ],
  [ "French Southern Territories", "TF" ],
  [ "Gabon", "GA" ],
  [ "Gambia", "GM" ],
  [ "Georgia", "GE" ],
  [ "Germany", "DE" ],
  [ "Ghana", "GH" ],
  [ "Gibraltar", "GI" ],
  [ "Greece", "GR" ],
  [ "Greenland", "GL" ],
  [ "Grenada", "GD" ],
  [ "Guadeloupe", "GP" ],
  [ "Guam", "GU" ],
  [ "Guatemala", "GT" ],
  [ "Guernsey", "GG" ],
  [ "Guinea", "GN" ],
  [ "Guinea-Bissau", "GW" ],
  [ "Guyana", "GY" ],
  [ "Haiti", "HT" ],
  [ "Heard Island and McDonald Islands", "HM" ],
  [ "Holy See", "VA" ],
  [ "Honduras", "HN" ],
  [ "Hong Kong", "HK" ],
  [ "Hungary", "HU" ],
  [ "Iceland", "IS" ],
  [ "India", "IN" ],
  [ "Indonesia", "ID" ],
  [ "Iran", "IR" ],
  [ "Iraq", "IQ" ],
  [ "Ireland", "IE" ],
  [ "Isle of Man", "IM" ],
  [ "Israel", "IL" ],
  [ "Italy", "IT" ],
  [ "Jamaica", "JM" ],
  [ "Japan", "JP" ],
  [ "Jersey", "JE" ],
  [ "Jordan", "JO" ],
  [ "Kazakhstan", "KZ" ],
  [ "Kenya", "KE" ],
  [ "Kiribati", "KI" ],
  [ "Korea, Democratic People's Republic of", "KP" ],
  [ "Korea, Republic of", "KR" ],
  [ "Kuwait", "KW" ],
  [ "Kyrgyzstan", "KG" ],
  [ "Lao People's Democratic Republic", "LA" ],
  [ "Latvia", "LV" ],
  [ "Lebanon", "LB" ],
  [ "Lesotho", "LS" ],
  [ "Liberia", "LR" ],
  [ "Libya", "LY" ],
  [ "Liechtenstein", "LI" ],
  [ "Lithuania", "LT" ],
  [ "Luxembourg", "LU" ],
  [ "Macao", "MO" ],
  [ "Madagascar", "MG" ],
  [ "Malawi", "MW" ],
  [ "Malaysia", "MY" ],
  [ "Maldives", "MV" ],
  [ "Mali", "ML" ],
  [ "Malta", "MT" ],
  [ "Marshall Islands", "MH" ],
  [ "Martinique", "MQ" ],
  [ "Mauritania", "MR" ],
  [ "Mauritius", "MU" ],
  [ "Mayotte", "YT" ],
  [ "Mexico", "MX" ],
  [ "Micronesia", "FM" ],
  [ "Moldova", "MD" ],
  [ "Monaco", "MC" ],
  [ "Mongolia", "MN" ],
  [ "Montenegro", "ME" ],
  [ "Montserrat", "MS" ],
  [ "Morocco", "MA" ],
  [ "Mozambique", "MZ" ],
  [ "Myanmar", "MM" ],
  [ "Namibia", "NA" ],
  [ "Nauru", "NR" ],
  [ "Nepal", "NP" ],
  [ "Netherlands", "NL" ],
  [ "New Caledonia", "NC" ],
  [ "New Zealand", "NZ" ],
  [ "Nicaragua", "NI" ],
  [ "Niger", "NE" ],
  [ "Nigeria", "NG" ],
  [ "Niue", "NU" ],
  [ "Norfolk Island", "NF" ],
  [ "North Macedonia", "MK" ],
  [ "Northern Mariana Islands", "MP" ],
  [ "Norway", "NO" ],
  [ "Oman", "OM" ],
  [ "Pakistan", "PK" ],
  [ "Palau", "PW" ],
  [ "Palestine", "PS" ],
  [ "Panama", "PA" ],
  [ "Papua New Guinea", "PG" ],
  [ "Paraguay", "PY" ],
  [ "Peru", "PE" ],
  [ "Philippines", "PH" ],
  [ "Pitcairn", "PN" ],
  [ "Poland", "PL" ],
  [ "Portugal", "PT" ],
  [ "Puerto Rico", "PR" ],
  [ "Qatar", "QA" ],
  [ "Réunion", "RE" ],
  [ "Romania", "RO" ],
  [ "Russian Federation", "RU" ],
  [ "Rwanda", "RW" ],
  [ "Saint Barthélemy", "BL" ],
  [ "Saint Helena", "SH" ],
  [ "Saint Kitts and Nevis", "KN" ],
  [ "Saint Lucia", "LC" ],
  [ "Saint Martin (French part)", "MF" ],
  [ "Saint Pierre and Miquelon", "PM" ],
  [ "Saint Vincent and the Grenadines", "VC" ],
  [ "Samoa", "WS" ],
  [ "San Marino", "SM" ],
  [ "Sao Tome and Principe", "ST" ],
  [ "Saudi Arabia", "SA" ],
  [ "Senegal", "SN" ],
  [ "Serbia", "RS" ],
  [ "Seychelles", "SC" ],
  [ "Sierra Leone", "SL" ],
  [ "Singapore", "SG" ],
  [ "Sint Maarten (Dutch part)", "SX" ],
  [ "Slovakia", "SK" ],
  [ "Slovenia", "SI" ],
  [ "Solomon Islands", "SB" ],
  [ "Somalia", "SO" ],
  [ "South Africa", "ZA" ],
  [ "South Georgia and the South Sandwich Islands", "GS" ],
  [ "South Sudan", "SS" ],
  [ "Spain", "ES" ],
  [ "Sri Lanka", "LK" ],
  [ "Sudan", "SD" ],
  [ "Suriname", "SR" ],
  [ "Svalbard and Jan Mayen", "SJ" ],
  [ "Sweden", "SE" ],
  [ "Switzerland", "CH" ],
  [ "Syrian Arab Republic", "SY" ],
  [ "Taiwan", "TW" ],
  [ "Tajikistan", "TJ" ],
  [ "Tanzania", "TZ" ],
  [ "Thailand", "TH" ],
  [ "Timor-Leste", "TL" ],
  [ "Togo", "TG" ],
  [ "Tokelau", "TK" ],
  [ "Tonga", "TO" ],
  [ "Trinidad and Tobago", "TT" ],
  [ "Tunisia", "TN" ],
  [ "Türkiye", "TR" ],
  [ "Turkmenistan", "TM" ],
  [ "Turks and Caicos Islands", "TC" ],
  [ "Tuvalu", "TV" ],
  [ "Uganda", "UG" ],
  [ "Ukraine", "UA" ],
  [ "United Arab Emirates", "AE" ],
  [ "United Kingdom", "GB" ],
  [ "United States", "US" ],
  [ "United States Minor Outlying Islands", "UM" ],
  [ "Uruguay", "UY" ],
  [ "Uzbekistan", "UZ" ],
  [ "Vanuatu", "VU" ],
  [ "Venezuela", "VE" ],
  [ "Viet Nam", "VN" ],
  [ "Virgin Islands (British)", "VG" ],
  [ "Virgin Islands (U.S.)", "VI" ],
  [ "Wallis and Futuna", "WF" ],
  [ "Western Sahara", "EH" ],
  [ "Yemen", "YE" ],
  [ "Zambia", "ZM" ],
  [ "Zimbabwe", "ZW" ]
]%>

<h1 class="text-2xl font-semibold text-gray-900 dark:text-white mt-8">Account</h1>

<div class="space-y-12 mt-12">

  <!-- TODO: Personal Information section -->
  <%= form_with model: @user do |form| %>
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-gray-900/10 pb-12 md:grid-cols-3 dark:border-white/10">
      <div>
        <h2 class="text-base/7 font-semibold text-gray-900 dark:text-white">Personal Information</h2>
        <p class="mt-1 text-sm/6 text-gray-600 dark:text-gray-400">How we communicate with you.</p>
      </div>

      <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6 md:col-span-2">

        <div class="sm:col-span-4">
          <%= form.label :name, "Name #{form.object.errors[:name].first}", class: "block text-sm/6 font-medium text-gray-900 dark:text-white" %>
          <div class="mt-2">
            <%= form.text_field :name, autocomplete: "given-name", class: "block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-primary-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:placeholder:text-gray-500 dark:focus:outline-primary-500" %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <%= form.label :email_address, "Email address #{form.object.errors[:email_address].first}", class: "block text-sm/6 font-medium text-gray-900 dark:text-white" %>
          <div class="mt-2">
            <%= form.email_field :email_address, autocomplete: "email", class: "block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-primary-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:placeholder:text-gray-500 dark:focus:outline-primary-500" %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <div class="mt-2 flex items-center justify-end">
            <%= form.submit "Save", class: "rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-primary-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600 dark:bg-primary-500 dark:shadow-none dark:focus-visible:outline-primary-500" %>
          </div>
        </div>

      </div>

    </div>
  <% end %>

  <!-- Render credit section -->
  <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-gray-900/10 pb-12 md:grid-cols-3 dark:border-white/10">
    <div>
      <h2 class="text-base/7 font-semibold text-gray-900 dark:text-white">Render credit</h2>
      <p class="mt-1 text-sm/6 text-gray-600 dark:text-gray-400">You can buy render credit and use it to render your projects.</p>
    </div>

    <%= form_with model: PaymentIntent.new, data: { turbo: false } do |form| %>

      <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6 md:col-span-2">

        <div class="sm:col-span-full">
          <p class="text-sm/6 font-semibold text-gray-900 dark:text-white">
            Balance: <%= number_to_currency Current.user&.render_credit_cents&.fdiv(100) %>
          </p>
        </div>

        <div class="sm:col-span-2 md:col-span-4 lg:col-span-3">

          <%= form.label :amount, "Add render credit", class: "block text-sm/6 font-medium text-gray-900 dark:text-white" %>
          <div class="mt-2">
            <div class="flex items-center rounded-md bg-white px-3 outline-1 -outline-offset-1 outline-gray-300 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-primary-600 dark:bg-white/5 dark:outline-white/10 dark:focus-within:outline-primary-500">
              <div class="shrink-0 text-base text-gray-500 select-none sm:text-sm/6 dark:text-gray-400">$</div>
              <%= form.number_field :amount, min: 10, value: 20, step: 1, class: "block min-w-0 grow bg-white py-1.5 pr-3 pl-1 text-base text-gray-900 placeholder:text-gray-400 focus:outline-none sm:text-sm/6 dark:bg-transparent dark:text-white dark:placeholder:text-gray-500" %>
              <div id="price-currency" class="shrink-0 text-base text-gray-500 select-none sm:text-sm/6 dark:text-gray-400">USD</div>
            </div>
          </div>
        </div>

        <div class="sm:col-span-2 self-end justify-self-end sm:justify-self-stretch">
          <%= form.hidden_field :reason, value: "credit_topup" %>
          <%= form.submit "Buy credit", class: "min-w-20 rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-primary-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600 dark:bg-primary-500 dark:shadow-none dark:focus-visible:outline-primary-500" %>
        </div>
      </div>

    <% end %>
  </div>

  <!-- Transactions section -->
  <% if Current.user.credit_entries.where(created_at: 60.days.ago..).where(reason: :topup).any? %>
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-gray-900/10 pb-12 md:grid-cols-3 dark:border-white/10">
      <div>
        <h2 class="text-base/7 font-semibold text-gray-900 dark:text-white">Transactions</h2>
        <p class="mt-1 text-sm/6 text-gray-600 dark:text-gray-400">Recent transactions you've made.</p>
      </div>

      <div class="md:col-span-2 space-y-8">
        <%= turbo_frame_tag "transactions", src: account_transactions_path, loading: :lazy do %>
          <p class="text-sm text-gray-500 dark:text-gray-400">Loading transactions...</p>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- TODO: Delete account section -->

  <% affiliate = Current.user.affiliate %>
  <% if affiliate.present? %>
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-gray-900/10 pb-12 md:grid-cols-3 dark:border-white/10">
      <div>
        <h2 class="text-base/7 font-semibold text-gray-900 dark:text-white">Referral Program</h2>
        <p class="mt-1 text-sm/6 text-gray-600 dark:text-gray-400">Earn rewards by helping other Blender artists find us.</p>
      </div>
      <div class="md:col-span-2 space-y-8">

        <div class="sm:flex sm:items-center">
          <div class="sm:flex-auto">

            <% affiliate_link = if affiliate.referral_code.present?
                 "https://blendergrid.com/how-to?ref=#{affiliate.referral_code}"
               else
                 "https://blendergrid.com/#{affiliate.landing_page.slug}"
               end %>
            <p class="text-sm/6 font-semibold text-gray-900 dark:text-white">
            Your affiliate link:<br/>
            <a href="<%= affiliate_link %>" target="_blank" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300">
              <%= affiliate_link %>
            </a>
            </p>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">
              <ol class="list-decimal list-inside text-sm">
                <li>Share your link with the Blender community</li>
                <li>Users who sign up get a $20 render credit gift to try Blendergrid</li>
                <li>Up to <%= Current.user.affiliate.reward_window_months %> months after signup, you earn <%= Current.user.affiliate.reward_percent %>% of all render payments they make</li>
              </ol>
            </p>
          </div>
        </div>

        <% if affiliate.has_referrals? %>
        <div class="col-span-full">
          <%= turbo_frame_tag "affiliate_stats", src: account_monthly_affiliate_stats_path, loading: :lazy do %>
            <p class="text-sm text-gray-500 dark:text-gray-400">Loading affiliate stats...</p>
          <% end %>
        </div>

        <div class="col-span-full">
          <h3 class="block text-sm/4 font-medium text-gray-900 dark:text-white">Payouts</h3>
          <p class="mt-1 text-sm/6 text-gray-600 dark:text-gray-400">Get paid out automatically when you have pending rewards.</p>

          <% if Current.user.affiliate.payout_onboarded_at.present? %>

            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
            <% if Current.user.affiliate.payout_method_details.present? %>
              <div class="mt-2">
                <p class="text-sm text-gray-700 dark:text-gray-300">
                  <% details = Current.user.affiliate.payout_method_details %>
                  <span class="font-medium">
                    <%= details["institution_name"] || details["bank_name"] %>
                  </span>
                  <% if details["account_type"].present? %>
                    <span class="capitalize"><%= details["account_type"] %></span>
                  <% elsif details["country"].present? %>
                    <span class="uppercase"><%= details["country"] %></span>
                  <% end %>
                  ••••<%= details["last4"] %>
                </p>
              </div>
            <% end %>

            <div class="mt-2 flex items-center gap-x-3">
              <%= button_to "Update payout method", account_payout_methods_path, data: { turbo: false }, class: "rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-xs inset-ring inset-ring-gray-300 hover:bg-gray-50 dark:bg-white/10 dark:text-white dark:shadow-none dark:inset-ring-white/5 dark:hover:bg-white/20" %>
            </div>
            </div>

          <% else %>

            <%= form_with url: account_payout_methods_path, method: :post, data: { turbo: false }, class: "mt-4" do |form| %>
              <div class="space-y-4">
                
                <div class="sm:col-span-full">
                  <%= form.label :country, "Country", class: "block text-sm/6 font-medium text-gray-900 dark:text-white" %>

                  <div class="mt-2 flex gap-4">

                    <div class="grid grid-cols-1">
                      <%= form.select :country, options_for_select(countries, "US"), {}, class: "col-start-1 row-start-1 w-full appearance-none rounded-md bg-white py-1.5 pr-8 pl-3 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-primary-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:*:bg-gray-800 dark:focus:outline-primary-500"
                      %>

                      <svg viewBox="0 0 16 16" fill="currentColor" data-slot="icon" aria-hidden="true" class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-500 sm:size-4 dark:text-gray-400">
                        <path d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                      </svg>

                    </div>

                    <div>
                      <%= form.submit "Set up payout method", class: "rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-primary-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600 dark:bg-primary-500 dark:shadow-none dark:focus-visible:outline-primary-500" %>
                    </div>
                  </div>
                </div>

              </div>
            <% end %>
          <% end %>
        </div>
        <% end %>

      </div>
    </div>
  <% end %>

</div>
