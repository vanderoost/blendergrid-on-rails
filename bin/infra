#!/usr/bin/env ruby

# Set up the cloud infrastructure with Terraform

require "fileutils"
require_relative "../config/application"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

Rails.application.initialize!

db_password = Rails.application.credentials.dig(:database, :password)
raise "Missing database password in credentials" unless db_password
terraform_vars = [ "-var", "db_password=#{db_password}" ]

FileUtils.chdir "#{APP_ROOT}/terraform" do
  system! "terraform", "init"
  system! "terraform", "apply", "-auto-approve", *terraform_vars
end
