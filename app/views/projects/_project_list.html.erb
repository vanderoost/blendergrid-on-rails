<%= turbo_stream_from :projects %>

<%
  projects_by_stage = projects.group_by(&:stage)
  Project::STAGES.each do |stage|
    stage_projects = projects_by_stage[stage] || []
%>

  <div class="mt-6">

    <% unless projects_by_stage.one? %>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <h3 class="mx-auto text-base uppercase text-gray-500 lg:mx-0
        dark:text-gray-400"><%= stage.to_s %></h3>
      </div>
    <% end %>

    <div class="bg-white dark:bg-gray-800/50 mt-3 overflow-hidden border
      border-gray-100 dark:border-white/10 rounded-xl">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="mx-auto lg:mx-0">
          <table class="w-full text-left">
            <thead class="sr-only">
              <tr>
                <th class="hidden">Enabled</th>
                <th>Project</th>
                <th class="hidden sm:table-cell">Type</th>
                <th>Edit</th>
              </tr>
            </thead>

            <tbody id="<%= stage %>-projects">
              <%= render stage_projects %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <% unless stage_projects.all?(&:in_progress?) %>

      <% case stage when :uploaded %>
        <%= form_with model: @quote || Quote.new, id: "quotes_form" do |form| %>
          <%= render "shared/form_errors", form: form %>

          <div class="mx-auto max-w-7xl flex justify-end">
            <%= form.submit "Calculate Price", class: "text-sm lg:text-base mt-4 lg:mt-5
            rounded-xl bg-primary-600 px-4 sm:px-6 lg:px-8 py-2.5 font-semibold
            text-white shadow-xs hover:bg-primary-500 focus-visible:outline-2
            focus-visible:outline-offset-2 focus-visible:outline-primary-600
            dark:bg-primary-500 dark:shadow-none dark:hover:bg-primary-400
            dark:focus-visible:outline-primary-500 cursor-pointer" %>
          </div>
        <% end %>

      <% when :waiting %>
        <%= form_with model: @order || Order.new, id: "orders_form", data: { turbo: false } do |form| %>
          <%= render "shared/form_errors", form: form %>

          <div class="mx-auto max-w-7xl flex justify-end">
            <%= form.submit "Start Rendering", class: "text-sm lg:text-base mt-4 lg:mt-5
            rounded-xl bg-primary-600 px-4 sm:px-6 lg:px-8 py-2.5 font-semibold
            text-white shadow-xs hover:bg-primary-500 focus-visible:outline-2
            focus-visible:outline-offset-2 focus-visible:outline-primary-600
            dark:bg-primary-500 dark:shadow-none dark:hover:bg-primary-400
            dark:focus-visible:outline-primary-500 cursor-pointer" %>
          </div>
        <% end %>

      <% end %>
    <% end %>

  </div>

<% end %>
