#!/usr/bin/env ruby

class AutoTest
  WATCHED_PATHS = %w[app test config lib].freeze
  WATCHED_EXTENSIONS = %w[rb erb yml].freeze
  POLL_INTERVAL_SECONDS = 0.5

  def initialize
    @file_times = {}
  end

  def start
    trap('INT') do
      exit
    end

    system("bin/rails db:migrate")

    loop do
      run_tests if a_file_changed?
      sleep POLL_INTERVAL_SECONDS
    end
  end

  private
    def a_file_changed?
      changed = false
      pattern = "**/*.{#{WATCHED_EXTENSIONS.join(',')}}"

      WATCHED_PATHS.each do |path|
        next unless Dir.exist?(path)

        Dir.glob(File.join(path, pattern)).each do |file|
          mtime = File.mtime(file)
          next if @file_times.dig(file) == mtime

          @file_times[file] = mtime
          changed = true
        end
      end

      changed
    end

    def run_tests
      system("clear")
      @rerun_all = @rubocop_success && @brakeman_success && @test_success

      if @rerun_all || ! @rubocop_success
        @rubocop_success = system("bin/rubocop")
        return unless @rubocop_success
      end

      if @rerun_all || ! @brakeman_success
        @brakeman_success = system("bin/brakeman", "--no-pager")
        return unless @brakeman_success
      end

      if @rerun_all || ! @test_success
        @test_success = system("bin/rails test --fail-fast") &&
                        system("bin/rails test:system --fail-fast")
      end
    end
end

AutoTest.new.start
