<%= turbo_stream_from [authenticated? ? Current.user.id : session.id.to_s, :projects] %>

<%
  projects_by_stage = projects.group_by(&:stage)
  Project::STAGES.each do |stage|
    stage_projects = projects_by_stage[stage] || []
%>
  <div data-controller="<%= "stage-submit" if [:uploaded, :waiting].include?(stage) %> <%= "price-summary" if stage == :waiting %>"
    class="group/stage hidden has-[tbody>tr]:block mt-6">

    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <h3 class="mx-auto text-base uppercase text-gray-500 lg:mx-0
        dark:text-gray-400"><%= stage.to_s %></h3>
    </div>

    <div class="bg-white dark:bg-gray-800/50 mt-3 overflow-hidden border
      border-gray-100 dark:border-white/10 rounded-xl">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="mx-auto lg:mx-0">
          <turbo-frame
            id="<%= stage %>-projects-table"
            target="_top"
            data-controller="poll"
            data-poll-path-value="<%= request.path %>"
            data-poll-is-forced-value="<%= [:finished, :stopped].include?(stage) && projects_by_stage[:rendering].present? %>"
            data-poll-interval-value="<%= case stage
                                          when :uploaded then 11.seconds.in_milliseconds
                                          when :waiting then 29.seconds.in_milliseconds
                                          when :rendering, :finished, :stopped then 59.seconds.in_milliseconds
                                          end %>">
            <table class="w-full text-left">
              <thead class="sr-only">
                <tr>
                  <th class="hidden">Enabled</th>
                  <th>Project</th>
                  <th class="hidden sm:table-cell">Type</th>
                  <th>Edit</th>
                </tr>
              </thead>

              <tbody id="<%= stage %>-projects" 
                data-price-summary-target="<%= "projectsTable" if stage == :waiting %>" >
                <%= render stage_projects %>
              </tbody>
            </table>
          </turbo-frame>
        </div>
      </div>
    </div>

    <% case stage when :uploaded %>

      <%= form_with model: @quote || Quote.new, id: "quotes_form" do |form| %>
        <%= render "shared/form_errors", form: form %>

        <div class="mx-auto max-w-7xl flex justify-end">
          <%= form.submit "Calculate Price", disabled: true,
            data: { stage_submit_target: "submit" },
            class: "text-sm lg:text-base mt-4 lg:mt-5 rounded-xl bg-primary-600 px-4 sm:px-6 lg:px-8 py-2.5 font-semibold text-white shadow-xs hover:not-disabled:bg-primary-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600 dark:bg-primary-500 dark:shadow-none dark:hover:not-disabled:bg-primary-400 dark:focus-visible:outline-primary-500 disabled:opacity-50 disabled:cursor-not-allowed" %>
        </div>
      <% end %>

    <% when :waiting %>

      <%= form_with model: @order || Order.new, id: "orders_form", data: { turbo: false } do |form| %>
        <%= render "shared/form_errors", form: form %>

        <div class="mx-auto max-w-7xl flex justify-end">
          <div data-price-summary-target="summaryDisplay"
            class="text-sm lg:text-base mt-4 mr-4 lg:mt-5 py-2.5">
          </div>

          <%= form.submit "Start Rendering",
            data: { stage_submit_target: "submit" },
            class: "text-sm lg:text-base mt-4 lg:mt-5 rounded-xl bg-primary-600 px-4 sm:px-6 lg:px-8 py-2.5 font-semibold text-white shadow-xs hover:not-disabled:bg-primary-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600 dark:bg-primary-500 dark:shadow-none dark:hover:not-disabled:bg-primary-400 dark:focus-visible:outline-primary-500 disabled:opacity-50 disabled:cursor-not-allowed" %>
        </div>
      <% end %>

    <% end %>
  </div>
<% end %>
